# Analytics Module - Appwrite Collections Schema

## Overview
This document defines the Appwrite collections needed for the wine QR code analytics system. The system will track QR code scans with various metrics as specified in the requirements.

## Collections

### 1. scan_events
This collection stores individual scan events when users access a wine's QR code page.

**Collection ID:** `scan_events`

**Attributes:**
- `id` (string): Unique identifier (generated by Appwrite)
- `timestamp` (datetime): When the scan occurred
- `ipAddress` (string, optional): Masked/hashed IP address for privacy
- `userAgent` (string, optional): User agent string
- `deviceType` (string, enum): "MOBILE", "TABLET", "DESKTOP", "UNKNOWN"
- `operatingSystem` (string, optional): OS name (iOS, Android, Windows, macOS, etc.)
- `browserLanguage` (string, optional): User's browser language preference
- `countryCode` (string, optional): 2-letter country code
- `regionCode` (string, optional): Region/state code
- `city` (string, optional): City name
- `languageUsed` (string, optional): Language version of the page viewed
- `referrer` (string, optional): Where the scan came from (if available)
- `wineId` (string): ID of the wine being viewed
- `wineName` (string): Name of the wine (denormalized for efficiency)
- `wineBatch` (string, optional): Batch number of the wine
- `wineVintage` (number, optional): Vintage of the wine
- `wineryId` (string): ID of the winery
- `wineryName` (string): Name of the winery (denormalized for efficiency)
- `winerySlug` (string): Slug of the winery

**Indexes:**
- timestamp (for time-based queries)
- wineId (for wine-specific analysis)
- wineryId (for winery-specific analysis)
- countryCode (for geographic analysis)
- deviceType (for device-type analysis)

**Access Permissions:**
- Create: Public (to allow anonymous scan recording)
- Read: Document owner (winery)
- Update: None
- Delete: Document owner (winery)

### 2. daily_scan_stats
This collection stores pre-aggregated daily statistics for faster dashboard loading.

**Collection ID:** `daily_scan_stats`

**Attributes:**
- `id` (string): Unique identifier
- `date` (datetime): The date these stats represent (normalized to start of day)
- `wineryId` (string): ID of the winery
- `wineId` (string, optional): ID of the wine (null for winery-level aggregates)
- `scanCount` (number): Total number of scans
- `uniqueVisitorsEstimate` (number): Estimated unique visitors
- `mobileCount` (number): Count of mobile device scans
- `tabletCount` (number): Count of tablet device scans
- `desktopCount` (number): Count of desktop device scans

**Indexes:**
- date (for time-based queries)
- wineryId (for winery-specific analysis)
- wineId (for wine-specific analysis)
- Composite index on [date, wineryId, wineId] for uniqueness

**Access Permissions:**
- Create: Server only
- Read: Document owner (winery)
- Update: Server only
- Delete: Server only

### 3. regional_scan_stats
This collection stores geographic aggregates of scan data.

**Collection ID:** `regional_scan_stats`

**Attributes:**
- `id` (string): Unique identifier
- `date` (datetime): The date these stats represent (normalized to start of day)
- `wineryId` (string): ID of the winery
- `wineId` (string, optional): ID of the wine (null for winery-level aggregates)
- `countryCode` (string): 2-letter country code
- `regionCode` (string, optional): Region/state code
- `city` (string, optional): City name
- `scanCount` (number): Total number of scans from this geographic location

**Indexes:**
- date (for time-based queries)
- wineryId (for winery-specific analysis)
- countryCode (for geographic filtering)
- Composite index on [date, wineryId, wineId, countryCode] for uniqueness

**Access Permissions:**
- Create: Server only
- Read: Document owner (winery)
- Update: Server only
- Delete: Server only

### 4. language_scan_stats
This collection tracks language preferences of users scanning QR codes.

**Collection ID:** `language_scan_stats`

**Attributes:**
- `id` (string): Unique identifier
- `date` (datetime): The date these stats represent
- `wineryId` (string): ID of the winery
- `wineId` (string, optional): ID of the wine (null for winery-level aggregates)
- `language` (string): Language code (e.g., "cs", "en", "de")
- `scanCount` (number): Total number of scans in this language

**Indexes:**
- date (for time-based queries)
- wineryId (for winery-specific analysis)
- language (for language filtering)
- Composite index on [date, wineryId, wineId, language] for uniqueness

**Access Permissions:**
- Create: Server only
- Read: Document owner (winery)
- Update: Server only
- Delete: Server only

### 5. hourly_scan_stats
This collection tracks scan patterns throughout the day.

**Collection ID:** `hourly_scan_stats`

**Attributes:**
- `id` (string): Unique identifier
- `date` (datetime): The date these stats represent
- `hour` (number): The hour of day (0-23)
- `wineryId` (string): ID of the winery
- `wineId` (string, optional): ID of the wine (null for winery-level aggregates)
- `scanCount` (number): Total number of scans during this hour

**Indexes:**
- date (for time-based queries)
- wineryId (for winery-specific analysis)
- hour (for time-of-day analysis)
- Composite index on [date, hour, wineryId, wineId] for uniqueness

**Access Permissions:**
- Create: Server only
- Read: Document owner (winery)
- Update: Server only
- Delete: Server only

### 6. wine_popularity_rankings
This collection stores pre-calculated rankings of the most scanned wines.

**Collection ID:** `wine_popularity_rankings`

**Attributes:**
- `id` (string): Unique identifier
- `date` (datetime): The date these rankings represent
- `periodType` (string): "daily", "weekly", "monthly", "yearly"
- `wineryId` (string): ID of the winery
- `rankings` (JSON array): Pre-calculated ranking data with structure:
  ```json
  [
    {
      "wineId": "wine-id-1",
      "wineName": "Wine Name 1",
      "scanCount": 145,
      "rank": 1
    },
    {
      "wineId": "wine-id-2",
      "wineName": "Wine Name 2",
      "scanCount": 120,
      "rank": 2
    }
  ]
  ```

**Indexes:**
- date (for time-based queries)
- wineryId (for winery-specific analysis)
- periodType (for filtering by time period)
- Composite index on [date, periodType, wineryId] for uniqueness

**Access Permissions:**
- Create: Server only
- Read: Document owner (winery)
- Update: Server only
- Delete: Server only